pipeline {
  agent any

  tools {
    jdk 'JDK17'
    maven 'M2_HOME' // Nom de ton Maven configuré dans Jenkins
  }

  environment {
    SONAR_TOKEN = credentials('jenkins-sonar')
    SONAR_HOST = 'http://192.168.33.10:9000'
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/samderouich2000/Backend-CI-CD.git'
      }
    }

    stage('Clean') {
      steps {
        script {
          def mvnHome = tool 'M2_HOME'  // récupère le chemin d'installation de Maven
          sh "${mvnHome}/bin/mvn -B clean"
        }
      }
    }

    stage('Compile') {
      steps {
        script {
          def mvnHome = tool 'M2_HOME'
          sh "${mvnHome}/bin/mvn -B -DskipTests=true compile"
        }
      }
    }

    stage('Analyse SonarQube') {
      steps {
        script {
          def mvnHome = tool 'M2_HOME'
          withSonarQubeEnv('sq1') {
            sh "${mvnHome}/bin/mvn -B sonar:sonar -Dsonar.host.url=${SONAR_HOST} -Dsonar.login=${SONAR_TOKEN}"
          }
        }
      }
    }

    stage('Package') {
      steps {
        script {
          def mvnHome = tool 'M2_HOME'
          sh "${mvnHome}/bin/mvn -B -DskipTests=true package"
        }
      }
    }

    stage('Archive') {
      steps {
        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
      }
    }
  }

  post {
    success {
      echo "✅ Build terminé avec succès !"
    }
    failure {
      echo "❌ Build échoué. Vérifie les logs Jenkins."
    }
  }
}
