pipeline {
  agent any

  tools {
    maven 'Maven3'  // Make sure this name matches Jenkins Global Tool Configuration
    jdk 'JDK17'     // Make sure this name matches Jenkins Global Tool Configuration
  }

  environment {
    SONAR_HOST = 'http://192.168.33.10:9000'
    DOCKER_IMAGE = 'samiraderouich/tp-projet'
    DOCKER_TAG = "${env.BUILD_ID}"
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/samderouich2000/Backend-CI-CD.git'
      }
    }

    stage('Clean') {
      steps {
        sh 'mvn -B clean'
      }
    }

    stage('Compile') {
      steps {
        sh 'mvn -B -DskipTests=true compile'
      }
    }

    stage('Test') {
      steps {
        sh 'mvn -B test'
      }
      post {
        always {
          junit 'target/surefire-reports/*.xml'
        }
      }
    }

    stage('Analyse SonarQube') {
      steps {
        withSonarQubeEnv('sq1') {  // Make sure 'sq1' matches Jenkins SonarQube server name
          sh "mvn -B sonar:sonar"
        }
      }
    }

    stage('Package') {
      steps {
        sh 'mvn -B -DskipTests=true package'
      }
    }

    stage('Archive') {
      steps {
        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          echo "üî® Construction de l'image Docker..."
          sh """
            docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
            docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
          """
        }
      }
    }

    stage('Push to Docker Hub') {
      steps {
        script {
          echo "üì§ Pushing image to Docker Hub..."
          withCredentials([usernamePassword(
            credentialsId: 'dockerhub-credentials',  // Fixed: consistent credential ID
            usernameVariable: 'DOCKER_USERNAME',
            passwordVariable: 'DOCKER_PASSWORD'
          )]) {
            sh """
              echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
              docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
              docker push ${DOCKER_IMAGE}:latest
            """
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
          echo "üöÄ D√©ploiement sur Kubernetes..."
          
          // Deploy MySQL
          sh 'kubectl apply -f mysql-secrets.yml'
          sh 'kubectl apply -f mysql-deployment.yml'
          
          // Wait for MySQL to be ready
          sh '''
            kubectl wait --for=condition=ready pod -l app=mysql --timeout=300s
            sleep 10
          '''
          
          // Deploy the application
          sh 'kubectl apply -f app-deployment.yml'
          
          // Verify deployment
          sh '''
            echo "=== V√©rification des d√©ployements ==="
            kubectl get pods
            kubectl get services
            echo "=== Attente du d√©marrage de l'application ==="
            sleep 30
            kubectl logs -l app=tp-projet --tail=10
          '''
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Build et D√©ploiement termin√©s avec succ√®s !"
      echo "üåê Application accessible sur: http://192.168.49.2:30089/tpProjet"
      echo "üê≥ Image Docker: ${DOCKER_IMAGE}:${DOCKER_TAG}"
    }
    failure {
      echo "‚ùå Build ou D√©ploiement √©chou√©. V√©rifie les logs Jenkins."
    }
    always {
      // Docker cleanup
      sh 'docker logout'
    }
  }
}
